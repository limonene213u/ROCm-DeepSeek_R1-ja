# Description_codes-analyze_deepseekr1.md

## 概要

`analyze_deepseekr1.py`は、DeepSeek R1 Distillシリーズモデルのトークナイザー、特にBPE（SentencePiece）の日本語対応状況を詳細に分析するためのツールである。このコードは論文執筆を意識した再現性の高い分析を目的として設計されており、統計的な解析結果を構造化されたデータとして出力する。

## 実装の意図

DeepSeek R1モデルの日本語特化チューニングを行う前段階として、素の状態でのトークナイザーの日本語処理能力を定量的に評価することが重要である。本コードは以下の観点から包括的な分析を実施する：

1. **語彙レベルの分析**: 日本語トークンの数と割合を定量化
2. **文字体系別分析**: ひらがな、カタカナ、漢字、混在トークンの分類
3. **効率性分析**: サブワード分割の効率性を測定
4. **実用性分析**: 一般的な日本語単語のカバレッジ評価

## クラス設計

### TokenAnalysisResult

```python
@dataclass
class TokenAnalysisResult:
    model_name: str
    vocab_size: int
    japanese_tokens: List[str]
    japanese_token_count: int
    japanese_ratio: float
    # ...その他の分析結果フィールド
```

このデータクラスは解析結果を構造化して格納する。各フィールドは特定の分析側面を表現しており、後続の比較分析や可視化において一貫したデータアクセスを可能にする。

### DeepSeekR1Analyzer

メインの解析クラスであり、以下の責務を持つ：

#### 初期化処理
```python
def __init__(self, output_dir: str = "Analyze_DeepSeekR1_Data"):
```

解析対象となる4つのDeepSeek R1 Distillモデルを定義し、日本語テストサンプルと一般的な日本語単語リストを準備する。出力ディレクトリの設定により、解析結果の一元管理を実現している。

#### 日本語トークン分析
```python
def _analyze_japanese_tokens(self, vocab: Dict[str, int]) -> Dict[str, List[str]]:
```

語彙内の各トークンに対してUnicode正規化を適用し、正規表現によって日本語文字体系を判定する。ひらがな（U+3040-U+309F）、カタカナ（U+30A0-U+30FF）、漢字（U+4E00-U+9FAF）の各範囲を用いて分類し、混在パターンも識別する。この分析により、モデルの日本語理解の基盤となる語彙構成を明らかにする。

#### サブワード効率分析
```python
def _analyze_subword_efficiency(self, tokenizer) -> Dict[str, float]:
```

日本語テストサンプルに対するトークン化処理を実行し、文字数対トークン数の比率（圧縮比）を計算する。低い圧縮比は効率的なトークン化を示し、日本語処理に適したモデルの指標となる。標準偏差の計算により、異なる文章タイプに対する安定性も評価する。

#### 一般単語カバレッジ分析
```python
def _analyze_common_word_coverage(self, tokenizer) -> Dict[str, bool]:
```

頻出する日本語単語リストに対して、直接的な語彙マッチングと単一トークンへの分割可能性を評価する。この分析により、実用的な日本語処理における各モデルの実効性を測定する。

## データ出力形式

### CSV形式の比較データ
`model_comparison.csv`には全モデルの定量的比較結果が格納される。語彙サイズ、日本語トークン比率、圧縮効率等の主要指標を横断的に比較可能な形式で提供する。

### JSON形式の詳細データ
各モデルについて`{model_name}_detailed_analysis.json`ファイルが生成され、トークンの具体例や詳細統計を含む包括的なデータが保存される。

### 可視化画像
`tokenizer_analysis_visualization.png`として6つのサブプロットからなる総合的な可視化を提供する。語彙サイズ、日本語トークン比率、文字体系別分布、圧縮効率、カバレッジ率、平均トークン長の比較が一覧できる。

### Markdownレポート
`analysis_summary_report.md`として実行サマリー、主要な発見、推奨事項を含むレポートを生成する。このレポートは論文執筆における参考資料として活用される。

## 統計的手法

トークン長の分析では平均値、中央値、標準偏差、四分位数等の記述統計を算出し、語彙の分布特性を把握する。圧縮比の分析では複数サンプルに対する平均と標準偏差により、安定性を定量化する。

## 再現性への配慮

ログ出力による処理過程の記録、エラーハンドリングによる堅牢性の確保、標準的なライブラリの使用により、異なる環境での再現可能性を担保している。また、Unicode正規化の適用により、文字エンコーディングの差異による結果のブレを防いでいる。

この実装により、DeepSeek R1モデルの日本語適応性を客観的かつ定量的に評価し、subsequent tuning戦略の策定における科学的根拠を提供する。
